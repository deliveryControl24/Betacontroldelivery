
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro y Facturación de Pedidos</title>
    <style>
        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: #f5f5f5; 
            margin: 0; 
            padding: 20px; 
        }
        h1, h2 { 
            color: #333; 
            text-align: center; 
            margin-bottom: 10px; 
        }
        img.logo {
            display: block;
            margin: 0 auto 20px; /* Centrar y añadir margen inferior */
            max-width: 100%; /* Asegurar que el logo no se salga de la pantalla */
            height: auto; /* Mantener proporciones del logo */
        }
        form, .card, table {
            width: 100%; 
            max-width: 600px; 
            margin: auto; 
            background-color: #fff; 
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            padding: 15px;
            margin-bottom: 20px;
            box-sizing: border-box; /* Asegurar que el padding no afecte el tamaño total */
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #f0f0f0; }
        button { 
            background-color: #6200ea; 
            color: #fff; 
            border: none; 
            padding: 10px; 
            border-radius: 4px; 
            cursor: pointer; 
            width: 100%; 
            transition: background-color 0.3s; 
            margin-top: 10px; /* Espaciado entre botones */
        }
        button:hover { background-color: #3700b3; }
        input, select { 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            padding: 10px; 
            width: 100%; 
            margin: 8px 0; 
            box-sizing: border-box; 
        }
        .voucher {
            padding: 20px; 
            border: 1px solid #000; 
            border-radius: 5px; 
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); 
            margin: auto; 
        }
        .statistics {
            text-align: center;
            margin-bottom: 20px;
        }
        .promotion-form {
            margin-top: 20px; 
        }
        @media (max-width: 600px) {
            button { padding: 8px; } /* Ajustar el tamaño de los botones en pantallas pequeñas */
            th, td { padding: 8px; } /* Ajustar el padding de las celdas en pantallas pequeñas */
        }
    </style>
</head>
<body>

<img src="logo.jpg" alt="Logo" class="logo"> <!-- Logo agregado aquí -->

<h1>Sistema de Registro y Facturación de Pedidos</h1>
<h2 id="currentDay"></h2>

<!-- Panel de Estadísticas -->
<div class="statistics">
    <h2>Estadísticas</h2>
    <p id="totalOrders">Total de Pedidos: 0</p>
    <p id="totalEarnings">Total Ganancias: 0 C$</p>
    <p id="mostActiveDeliveryPerson">Repartidor Más Activo: Ninguno</p>
</div>

<!-- Formulario para registrar un nuevo pedido -->
<form id="orderForm">
    <h2>Registrar Nuevo Pedido</h2>
    <label>Referencia: <input type="text" id="pickup" required></label>
    <label>Costo de Delivery (C$): <input type="number" id="cash" min="0" required></label>
    <label>Nombre de Repartidor: 
        <input type="text" id="deliveryPersonInput" placeholder="Buscar Repartidor" required>
        <select id="deliveryPersonSelect" style="display: none;"></select>
    </label>
    <label>Tipo de Pedido: 
        <select id="orderType">
            <option value="">Seleccione un tipo de pedido (opcional)</option>
            <option value="normal">Pedidos Normales</option>
            <option value="promotion">Pedidos en Promoción o Descuento</option>
            <option value="freeDelivery">Delivery Gratis</option>
        </select>
    </label>
    <button type="submit">Añadir Pedido</button>
    <button type="button" onclick="clearAllOrders()">Limpiar/Borrar</button>
    <div id="deleteConfirmation" style="display:none;">
        <p>¿Está seguro de que desea eliminar todos los pedidos?</p>
        <button onclick="clearEarnings()">Sí</button>
        <button onclick="toggleDeleteConfirmation()">No</button>
    </div>
</form>

<!-- Formulario para guardar un nuevo repartidor -->
<h2>Guardar Repartidor</h2>
<form id="deliveryPersonForm">
    <label>Nombre de Repartidor: <input type="text" id="newDeliveryPersonName" required></label>
    <button type="button" onclick="addDeliveryPerson()">Añadir Repartidor</button>
</form>

<!-- Tabla para mostrar los repartidores guardados -->
<h2>Repartidores</h2>
<div id="deliveryPersonListContainer">
    <table>
        <thead>
            <tr>
                <th>Nombre de Repartidor</th>
                <th>Acciones</th>
                <th>Totales</th>
                <th>Sumar</th>
            </tr>
        </thead>
        <tbody id="deliveryPersonList"></tbody>
    </table>
</div>

<!-- Apartado de Configuración de Promociones -->
<h2>Configuración de Promociones</h2>
<div class="promotion-form">
    <label>Nombre de la Promoción: <input type="text" id="promotionName" required></label>
    <label>Descuento (%): <input type="number" id="promotionDiscount" min="0" max="100" required></label>
    <button type="button" onclick="addPromotion()">Añadir Promoción</button>
</div>

<!-- Tabla de Promociones -->
<h2>Promociones Activas</h2>
<div id="promotionListContainer">
    <table>
        <thead>
            <tr>
                <th>Nombre de Promoción</th>
                <th>Descuento (%)</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="promotionList"></tbody>
    </table>
</div>

<!-- Seleccionar pedido para guardar como voucher -->
<h2>Seleccionar Pedido para Guardar</h2>
<label for="orderSelect">Selecciona el Pedido:</label>
<select id="orderSelect"></select>
<label for="fileFormat">Seleccionar Formato:</label>
<select id="fileFormat">
    <option value="pdf">PDF</option>
    <option value="jpg">JPG</option>
    <option value="txt">TXT</option>
</select>
<button onclick="exportSelectedOrderAsVoucher()">Guardar Pedido</button>
<button onclick="sendOrderToWhatsApp()">Enviar Pedido a WhatsApp</button>

<!-- Sección para mostrar ganancias del día -->
<div id="totalEarningsDisplay">Total Ganancias: 0 C$</div>
<button onclick="calculateTotalEarnings()">Calcular Total Ganancias del Día</button>

<!-- Conteo de pedidos por repartidor -->
<h2>Conteo de Pedidos por Repartidor</h2>
<div id="deliveryPersonCountContainer">
    <table>
        <thead>
            <tr>
                <th>Nombre de Repartidor</th>
                <th>Conteo de Pedidos</th>
                <th>Total Costo (C$)</th>
            </tr>
        </thead>
        <tbody id="deliveryPersonCountTable"></tbody>
    </table>
    <button onclick="downloadDeliveryPersonCount()">Descargar Conteo de Repartidores</button>
</div>

<!-- Tabla para mostrar los pedidos registrados -->
<div id="orderTableContainer">
    <table>
        <thead>
            <tr>
                <th>Referencia</th>
                <th>Costo de Delivery (C$)</th>
                <th>Nombre de Repartidor</th>
                <th>Tipo de Pedido</th>
            </tr>
        </thead>
        <tbody id="orderTable"></tbody>
        <tfoot>
            <tr>
                <td colspan="2" class="total">Total Diario de Pedidos</td>
                <td id="dailyTotal">0</td>
                <td></td>
            </tr>
        </tfoot>
    </table>
</div>

<!-- Historial de pedidos -->
<div id="historyContainer">
    <h2>Historial de Pedidos</h2>
    <table>
        <thead>
            <tr>
                <th>Referencia</th>
                <th>Costo de Delivery (C$)</th>
                <th>Nombre de Repartidor</th>
                <th>Tipo de Pedido</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="historyTable"></tbody>
    </table>
</div>

<script>
    let orders = JSON.parse(localStorage.getItem('orders')) || [];
    let deliveryPersons = JSON.parse(localStorage.getItem('deliveryPersons')) || [];
    let promotions = JSON.parse(localStorage.getItem('promotions')) || [];

    document.getElementById('currentDay').textContent = `Día: ${new Date().toLocaleString('es-ES', { weekday: 'long' })}`;

    document.getElementById('orderForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const order = {
            pickup: this.pickup.value,
            cash: parseFloat(this.cash.value),
            deliveryPersonName: document.getElementById('deliveryPersonInput').value,
            orderType: document.getElementById('orderType').value || "Normal",
        };
        orders.push(order);
        localStorage.setItem('orders', JSON.stringify(orders));
        this.reset();
        renderOrders();
        renderHistory();
        updateOrderSelect();
        updateDeliveryPersonCount();
        updateOrderSummary();
        updateStatistics();
        updateDeliveryPersonList();
    });

    function clearAllOrders() {
        if (confirm("¿Está seguro de que desea eliminar todos los pedidos?")) {
            orders = [];
            localStorage.setItem('orders', JSON.stringify(orders));
            renderOrders();
            renderHistory();
            updateOrderSelect();
            updateDeliveryPersonCount();
            updateStatistics();
        }
    }

    function addDeliveryPerson() {
        const deliveryPersonName = document.getElementById('newDeliveryPersonName').value.trim();
        if (deliveryPersonName && !deliveryPersons.includes(deliveryPersonName)) {
            deliveryPersons.push(deliveryPersonName);
            localStorage.setItem('deliveryPersons', JSON.stringify(deliveryPersons));
            updateDeliveryPersonList();
            updateDeliveryPersonSelect();
            document.getElementById('newDeliveryPersonName').value = '';
        } else if (deliveryPersons.includes(deliveryPersonName)) {
            alert("El repartidor ya existe.");
        }
    }

    function updateDeliveryPersonList() {
        const deliveryPersonListBody = document.getElementById('deliveryPersonList');
        deliveryPersonListBody.innerHTML = '';
        deliveryPersons.forEach((name) => {
            const row = document.createElement('tr');
            const totalCost = calculateTotalCostByDeliveryPerson(name);
            const totalOrders = calculateOrderCountByDeliveryPerson(name);
            row.innerHTML = `
                <td>${name}</td>
                <td><button onclick="removeDeliveryPerson(${index})">Eliminar</button></td>
                <td>${totalOrders} Pedidos</td>
                <td><button onclick="alertTotalByDeliveryPerson('${name}')">Sumar</button></td>
            `;
            deliveryPersonListBody.appendChild(row);
        });
    }

    function calculateTotalCostByDeliveryPerson(name) {
        return orders.filter(order => order.deliveryPersonName === name).reduce((total, order) => total + order.cash, 0);
    }

    function calculateOrderCountByDeliveryPerson(name) {
        return orders.filter(order => order.deliveryPersonName === name).length;
    }

    function alertTotalByDeliveryPerson(name) {
        const totalCost = calculateTotalCostByDeliveryPerson(name);
        alert(`Total Costo para ${name}: C$ ${totalCost}`);
    }

    function updateDeliveryPersonSelect() {
        const deliveryPersonSelect = document.getElementById('deliveryPersonSelect');
        deliveryPersonSelect.innerHTML = '<option value="">Seleccione un Repartidor</option>';
        deliveryPersons.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            deliveryPersonSelect.appendChild(option);
        });
    }

    function removeDeliveryPerson(index) {
        deliveryPersons.splice(index, 1);
        localStorage.setItem('deliveryPersons', JSON.stringify(deliveryPersons));
        updateDeliveryPersonList();
        updateDeliveryPersonSelect();
        updateDeliveryPersonCount();
    }

    function renderOrders() {
        const tableBody = document.getElementById('orderTable');
        tableBody.innerHTML = '';
        let dailyTotal = 0;

        orders.forEach((order) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${order.pickup}</td>
                <td>${order.cash} C$</td>
                <td>${order.deliveryPersonName}</td>
                <td>${order.orderType}</td>
            `;
            tableBody.appendChild(row);
            dailyTotal += order.cash;
        });

        document.getElementById('dailyTotal').textContent = dailyTotal + ' C$';
    }

    function renderHistory() {
        const historyTableBody = document.getElementById('historyTable');
        historyTableBody.innerHTML = '';

        orders.forEach((order, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${order.pickup}</td>
                <td>${order.cash} C$</td>
                <td>${order.deliveryPersonName}</td>
                <td>${order.orderType}</td>
                <td><button onclick="deleteOrder(${index})">Eliminar</button></td>
            `;
            historyTableBody.appendChild(row);
        });
    }

    function updateDeliveryPersonCount() {
        const deliveryPersonCount = {};
        orders.forEach(order => {
            if (deliveryPersonCount[order.deliveryPersonName]) {
                deliveryPersonCount[order.deliveryPersonName].count++;
                deliveryPersonCount[order.deliveryPersonName].total += order.cash;
            } else {
                deliveryPersonCount[order.deliveryPersonName] = { count: 1, total: order.cash };
            }
        });

        const deliveryPersonCountTableBody = document.getElementById('deliveryPersonCountTable');
        deliveryPersonCountTableBody.innerHTML = '';

        for (const [name, data] of Object.entries(deliveryPersonCount)) {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${name}</td><td>${data.count}</td><td>${data.total} C$</td>`;
            deliveryPersonCountTableBody.appendChild(row);
        }
    }

    function deleteOrder(index) {
        orders.splice(index, 1);
        localStorage.setItem('orders', JSON.stringify(orders));
        renderOrders();
        renderHistory();
        updateOrderSelect();
        updateDeliveryPersonCount();
        updateStatistics();
    }

    function updateOrderSelect() {
        const orderSelect = document.getElementById('orderSelect');
        orderSelect.innerHTML = '';
        orders.forEach((order, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `Pedido ${index + 1}`;
            orderSelect.appendChild(option);
        });
    }

    async function exportSelectedOrderAsVoucher() {
        const selectedOrderIndex = document.getElementById('orderSelect').value;
        const order = orders[selectedOrderIndex];
        const voucherContainer = document.createElement('div');
        voucherContainer.className = 'voucher';
        voucherContainer.innerHTML = `
            <h2>Voucher de Pedido</h2>
            <p><strong>Referencia:</strong> ${order.pickup}</p>
            <p><strong>Costo de Delivery:</strong> ${order.cash} C$</p>
            <p><strong>Nombre de Repartidor:</strong> ${order.deliveryPersonName}</p>
            <p><strong>Tipo de Pedido:</strong> ${order.orderType}</p>
        `;
        
        document.body.appendChild(voucherContainer);
        const canvas = await html2canvas(voucherContainer);
        const imgData = canvas.toDataURL("image/png");
        document.body.removeChild(voucherContainer);

        const fileFormat = document.getElementById('fileFormat').value;
        if (fileFormat === 'pdf') {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            pdf.addImage(imgData, 'PNG', 10, 10, 190, 0);
            pdf.save(`voucher_pedido_${parseInt(selectedOrderIndex) + 1}.pdf`);
        } else if (fileFormat === 'txt') {
            const textBlob = new Blob([JSON.stringify(order)], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(textBlob);
            link.download = `voucher_pedido_${parseInt(selectedOrderIndex) + 1}.txt`;
            link.click();
        } else {
            const link = document.createElement('a');
            link.href = imgData;
            link.download = `voucher_pedido_${parseInt(selectedOrderIndex) + 1}.jpg`;
            link.click();
        }
    }

    function sendOrderToWhatsApp() {
        const selectedOrderIndex = document.getElementById('orderSelect').value;
        const order = orders[selectedOrderIndex];

        const message = `Nuevo Pedido:\n` +
                        `Referencia: ${order.pickup}\n` +
                        `Costo de Delivery: ${order.cash} C$\n` +
                        `Nombre de Repartidor: ${order.deliveryPersonName}\n` +
                        `Tipo de Pedido: ${order.orderType}`;

        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
    }

    function updateStatistics() {
        const totalOrders = orders.length;
        const totalEarnings = orders.reduce((total, order) => total + order.cash, 0);
        const deliveryPersonCount = {};

        orders.forEach(order => {
            if (deliveryPersonCount[order.deliveryPersonName]) {
                deliveryPersonCount[order.deliveryPersonName]++;
            } else {
                deliveryPersonCount[order.deliveryPersonName] = 1;
            }
        });

        const mostActiveDeliveryPerson = Object.keys(deliveryPersonCount).reduce((a, b) => deliveryPersonCount[a] > deliveryPersonCount[b] ? a : b, '');

        document.getElementById('totalOrders').textContent = `Total de Pedidos: ${totalOrders}`;
        document.getElementById('totalEarnings').textContent = `Total Ganancias: ${totalEarnings} C$`;
        document.getElementById('mostActiveDeliveryPerson').textContent = `Repartidor Más Activo: ${mostActiveDeliveryPerson || 'Ninguno'}`;
    }

    function calculateTotalEarnings() {
        const totalEarnings = orders.reduce((total, order) => total + order.cash, 0);
        alert(`Total Ganancias del Día: C$ ${totalEarnings}`);
    }

    function addPromotion() {
        const promotionName = document.getElementById('promotionName').value.trim();
        // Código para añadir promoción...
    }
</script>

</body>
</html>