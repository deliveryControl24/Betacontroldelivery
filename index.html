<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Delivery Express - Registro</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #333;
    }
    .header {
      width: 100%;
      background: #2196F3;
      color: white;
      text-align: center;
      padding: 10px;
    }
    .header img { max-height: 50px; }
    .container {
      width: 90%;
      max-width: 700px;
      background: white;
      padding: 20px;
      margin-top: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    h1 { color:#2196F3; text-align:center; margin-bottom:20px; }
    label { font-weight:bold; display:block; margin-top:10px; }
    input, select, button {
      width:100%; padding:10px; margin-top:5px;
      border-radius:5px; border:1px solid #ccc; font-size:16px;
    }
    button {
      background:#2196F3; color:white; font-weight:bold;
      margin-top:10px; cursor:pointer;
    }
    button:hover { background:#1976D2; }
    .confirm-delete {
      display:none; background:#fff3cd; color:#856404;
      padding:10px; border-radius:5px; margin-top:10px; text-align:center;
    }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; }
    th { background:#f2f2f2; font-weight:bold; }
    tr:hover { background:#f5f5f5; }
    .delete-button {
      background:#d9534f; color:white; border:none;
      padding:5px 10px; border-radius:5px; cursor:pointer;
    }
    .delete-button:hover { background:#c9302c; }
  </style>
</head>
<body>
  <div class="header">
    <img src="logo.jpg" alt="Logo Delivery Express">
  </div>

  <div class="container">
    <h1>Registro de Delivery</h1>

    <label>Referencia:</label>
    <input type="text" id="referencia">

    <label>Costo del Delivery (C$):</label>
    <input type="number" id="costo">

    <label>Motorizado:</label>
    <select id="motorizadoSelect">
      <option value="">-- Selecciona --</option>
    </select>
    <input type="text" id="nuevoMotorizado" placeholder="Agregar nuevo motorizado">
    <button onclick="agregarMotorizado()">Agregar Motorizado</button>

    <label>Tipo de Entrega:</label>
    <select id="tipoDelivery">
      <option value="Normal">Normal</option>
      <option value="Promo">Promo</option>
      <option value="Gratis">Gratis</option>
    </select>

    <label>Fecha:</label>
    <input type="date" id="fecha">

    <button onclick="registrarDelivery()">Registrar Delivery</button>

    <label>Seleccionar Delivery para enviar:</label>
    <select id="deliverySelect" onchange="mostrarBotonWhatsApp()">
      <option value="">-- Selecciona --</option>
    </select>
    <button id="whatsappButton" onclick="enviarWhatsApp()" style="display:none;">Enviar por WhatsApp</button>

    <div class="confirm-delete" id="confirmDelete">
      <p>Â¿Eliminar todos los registros?</p>
      <button onclick="limpiarDeliverys()">SÃ­</button>
      <button onclick="cancelarEliminar()">No</button>
    </div>

    <h2>Historial de Entregas</h2>
    <button onclick="exportarExcel()">ðŸ“Š Exportar a Excel</button>
    <button onclick="imprimirHistorial()">ðŸ–¨ Imprimir</button>
    <input type="text" id="buscar" placeholder="Buscar en historial..." onkeyup="filtrarHistorial()">

    <table id="historialTable">
      <thead>
        <tr>
          <th>Referencia</th><th>Costo</th><th>Tipo</th><th>Motorizado</th><th>Fecha</th><th>Acciones</th>
        </tr>
      </thead>
      <tbody id="historialContainer"></tbody>
    </table>

    <button onclick="confirmarEliminar()">Limpiar Todos los Deliverys</button>
    <button onclick="limpiarHistorial()">Limpiar Historial</button>
  </div>

  <!-- SheetJS para exportar Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // ====== Cargar inicial ======
    document.addEventListener("DOMContentLoaded", ()=>{
      cargarDeliverys();
      cargarHistorial();
      document.getElementById("fecha").valueAsDate = new Date(); // Fecha automÃ¡tica
    });

    function cargarDeliverys(){
      const entregas = JSON.parse(localStorage.getItem("entregas")) || {};
      const motorizadoSelect = document.getElementById("motorizadoSelect");
      motorizadoSelect.innerHTML = '<option value="">-- Selecciona --</option>';
      const deliverySelect = document.getElementById("deliverySelect");
      deliverySelect.innerHTML = '<option value="">-- Selecciona --</option>';

      for(let motorizado in entregas){
        let option = document.createElement("option");
        option.value = motorizado;
        option.textContent = motorizado;
        motorizadoSelect.appendChild(option);

        entregas[motorizado].forEach((entrega,i)=>{
          let op = document.createElement("option");
          op.value = motorizado+"|"+i;
          op.textContent = `${entrega.referencia} - C$${entrega.costo} (${entrega.tipo})`;
          deliverySelect.appendChild(op);
        });
      }
    }

    function cargarHistorial(){
      const historial = JSON.parse(localStorage.getItem("historial")) || [];
      const tbody = document.getElementById("historialContainer");
      tbody.innerHTML = "";
      historial.forEach(item=>{
        let tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.referencia}</td>
          <td>C$${item.costo}</td>
          <td>${item.tipo}</td>
          <td>${item.motorizado}</td>
          <td>${item.fecha}</td>
          <td><button class="delete-button" onclick="confirmarEliminarFila(this)">Eliminar</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function registrarDelivery(){
      let referencia = document.getElementById("referencia").value.trim();
      let costo = parseFloat(document.getElementById("costo").value);
      let motorizado = document.getElementById("motorizadoSelect").value;
      let tipo = document.getElementById("tipoDelivery").value;
      let fecha = document.getElementById("fecha").value;

      if(!referencia || isNaN(costo) || !motorizado){ alert("Completa todos los campos"); return; }

      let entregas = JSON.parse(localStorage.getItem("entregas")) || {};
      if(!entregas[motorizado]) entregas[motorizado]=[];
      let entrega = {referencia,costo,tipo,fecha};
      entregas[motorizado].push(entrega);
      localStorage.setItem("entregas",JSON.stringify(entregas));

      let historial = JSON.parse(localStorage.getItem("historial")) || [];
      historial.push({referencia,costo,tipo,motorizado,fecha});
      localStorage.setItem("historial",JSON.stringify(historial));

      cargarDeliverys();
      cargarHistorial();

      document.getElementById("referencia").value="";
      document.getElementById("costo").value="";
    }

    function agregarMotorizado(){
      let nuevo = document.getElementById("nuevoMotorizado").value.trim();
      if(!nuevo){ alert("Ingrese un nombre"); return; }
      let entregas = JSON.parse(localStorage.getItem("entregas")) || {};
      if(!entregas[nuevo]) entregas[nuevo]=[];
      localStorage.setItem("entregas",JSON.stringify(entregas));
      document.getElementById("nuevoMotorizado").value="";
      cargarDeliverys();
    }

    function enviarWhatsApp(){
      let sel = document.getElementById("deliverySelect").value;
      if(!sel){ alert("Seleccione un delivery"); return; }
      let [motorizado,i] = sel.split("|");
      let entregas = JSON.parse(localStorage.getItem("entregas")) || {};
      let d = entregas[motorizado][i];
      let msg = `Nuevo Delivery:%0ARef: ${d.referencia}%0ACosto: C$${d.costo}%0AMotorizado: ${motorizado}%0ATipo: ${d.tipo}%0AFecha: ${d.fecha}`;
      window.open("https://wa.me/?text="+msg,"_blank");
    }

    function mostrarBotonWhatsApp(){
      document.getElementById("whatsappButton").style.display =
        document.getElementById("deliverySelect").value ? "block":"none";
    }

    function confirmarEliminar(){ document.getElementById("confirmDelete").style.display="block"; }
    function cancelarEliminar(){ document.getElementById("confirmDelete").style.display="none"; }
    function limpiarDeliverys(){
      localStorage.removeItem("entregas");
      document.getElementById("confirmDelete").style.display="none";
      cargarDeliverys();
    }
    function limpiarHistorial(){ localStorage.removeItem("historial"); cargarHistorial(); }

    function confirmarEliminarFila(btn){
      if(confirm("Â¿Seguro de eliminar este registro?")){
        let ref = btn.parentNode.parentNode.cells[0].textContent;
        let historial = JSON.parse(localStorage.getItem("historial")) || [];
        historial = historial.filter(h=>h.referencia!==ref);
        localStorage.setItem("historial",JSON.stringify(historial));
        cargarHistorial();
      }
    }

    function exportarExcel(){
      let historial = JSON.parse(localStorage.getItem("historial")) || [];
      let ws = XLSX.utils.json_to_sheet(historial);
      let wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,"Historial");
      XLSX.writeFile(wb,"HistorialDelivery.xlsx");
    }

    function imprimirHistorial(){
      let div = document.getElementById("historialTable").outerHTML;
      let w = window.open("");
      w.document.write("<h1>Historial de Deliveries</h1>"+div);
      w.print();
    }

    function filtrarHistorial(){
      let filtro = document.getElementById("buscar").value.toLowerCase();
      let filas = document.querySelectorAll("#historialContainer tr");
      filas.forEach(f=>{
        f.style.display = f.innerText.toLowerCase().includes(filtro) ? "" : "none";
      });
    }
  </script>
</body>
</html>